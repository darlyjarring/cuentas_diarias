<!DOCTYPE html>
<html>
<head>
    <title>Gestión de Clientes y Reportes</title>
    <!-- Librerías de Firebase (Clásico V8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- Tu archivo de configuración donde está la variable global 'db' -->
    <script src="firebase-config.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; padding: 30px; border-radius: 12px; background-color: #ffffff; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 30px; }
        .section-header { color: #34495e; margin-top: 25px; margin-bottom: 15px; font-size: 1.25em; border-left: 5px solid #3498db; padding-left: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-group input { flex-grow: 1; }
        button { padding: 10px 15px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .btn-red { background-color: #e74c3c; }
        .btn-red:hover { background-color: #c0392b; }
        .btn-green { background-color: #2ecc71; }
        .btn-green:hover { background-color: #27ae60; }
        .resultado { padding: 15px; border-radius: 6px; margin-top: 15px; text-align: center; font-weight: bold; }

        /* Reportes */
        #reportesCliente { margin-top: 30px; }
        .resumen-global { display: flex; justify-content: space-around; background-color: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 1.1em; }
        .loan-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #f9f9f9; }
        .loan-card h4 { margin-top: 0; color: #3498db; }
        .loan-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em; }
        .stat-item { padding: 5px 0; border-bottom: 1px dashed #eee; }
        .stat-item strong { color: #2c3e50; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; display: inline-block; margin-left: 10px; }
        .status-Activo { background-color: #f1c40f; color: #333; }
        .status-Saldado { background-color: #2ecc71; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>Central de Gestión de Clientes y Reportes</h2>

    <!-- Sección de Búsqueda y Edición de Clientes -->
    <div class="section-header">1. Búsqueda y Modificación de Clientes</div>
    <div class="input-group">
        <input type="text" id="inputClienteId" placeholder="Ingrese ID (Cédula) del Cliente" />
        <button onclick="cargarClienteParaEdicion()">Buscar Cliente</button>
    </div>
    
    <div id="formEdicionCliente" style="display:none; border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0;">Editar Datos del Cliente</h3>
        <input type="hidden" id="cedulaOriginal">
        <label for="editNombre">Nombre Completo:</label>
        <input type="text" id="editNombre" required>
        <label for="editCedula">Nueva Cédula/ID:</label>
        <input type="text" id="editCedula" required>
        <button onclick="guardarCambiosCliente()" class="btn-green">Guardar Cambios</button>
    </div>

    <!-- Sección de Reportes -->
    <div class="section-header">2. Reportes Financieros del Cliente</div>
    <div id="reportesCliente" style="display:none;">
        <div class="resumen-global">
            <div>Total Préstamos: <strong id="totalPrestamos">0</strong></div>
            <div>Total Pagado Global: <strong id="totalPagadoGlobal">$0.00</strong></div>
            <div>Total Saldo Pendiente: <strong id="totalSaldoPendienteGlobal">$0.00</strong></div>
        </div>
        
        <div id="listadoPrestamos">
            <!-- Las tarjetas de préstamos se insertarán aquí -->
        </div>
    </div>
    
    <div id="resultado" class="resultado"></div>
</div>

<script>
    // Variables de referencia de Firestore
    const clientesRef = typeof db !== 'undefined' ? db.collection('clientes') : null;
    const prestamosRef = typeof db !== 'undefined' ? db.collection('prestamos') : null;
    const pagosRef = typeof db !== 'undefined' ? db.collection('pagos') : null;
    let clienteSeleccionado = null;

    function mostrarResultado(mensaje, esError = false) {
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.textContent = esError ? '❌ Error: ' + mensaje : '✅ ' + mensaje;
        resultadoDiv.style.backgroundColor = esError ? '#f4cccc' : '#d9ead3';
        setTimeout(() => {
            resultadoDiv.textContent = '';
            resultadoDiv.style.backgroundColor = 'transparent';
        }, 6000);
    }

    // =======================================================
    // 1. LÓGICA DE EDICIÓN DE CLIENTES
    // =======================================================

    async function cargarClienteParaEdicion() {
        const idCliente = document.getElementById('inputClienteId').value.trim();
        if (!idCliente) {
            mostrarResultado('Ingrese una Cédula/ID para buscar.', true);
            return;
        }

        try {
            const clienteDoc = await clientesRef.doc(idCliente).get();
            if (clienteDoc.exists) {
                clienteSeleccionado = clienteDoc.data();
                document.getElementById('editNombre').value = clienteSeleccionado.nombre;
                document.getElementById('editCedula').value = clienteDoc.id;
                document.getElementById('cedulaOriginal').value = clienteDoc.id; // Guarda el ID original
                document.getElementById('formEdicionCliente').style.display = 'block';
                mostrarResultado(`Cliente "${clienteSeleccionado.nombre}" cargado.`, false);
                
                // Cargar reportes del cliente
                cargarReportes(idCliente);

            } else {
                mostrarResultado('Cliente no encontrado.', true);
                document.getElementById('formEdicionCliente').style.display = 'none';
                document.getElementById('reportesCliente').style.display = 'none';
                clienteSeleccionado = null;
            }
        } catch (e) {
            console.error("Error al cargar cliente:", e);
            mostrarResultado("Error al cargar datos: " + e.message, true);
        }
    }

    async function guardarCambiosCliente() {
        const nombreNuevo = document.getElementById('editNombre').value.trim();
        const cedulaNueva = document.getElementById('editCedula').value.trim();
        const cedulaOriginal = document.getElementById('cedulaOriginal').value.trim();

        if (!nombreNuevo || !cedulaNueva) {
            mostrarResultado('Nombre y Cédula/ID son obligatorios.', true);
            return;
        }

        try {
            if (cedulaNueva === cedulaOriginal) {
                // Caso 1: Solo se actualiza el Nombre
                await clientesRef.doc(cedulaOriginal).update({ nombre: nombreNuevo });
                mostrarResultado('Nombre del cliente actualizado con éxito.', false);
            } else {
                // Caso 2: Se actualiza la Cédula/ID (Requiere transacción para mover y actualizar préstamos)
                await db.runTransaction(async (transaction) => {
                    // a) Obtener el documento original del cliente
                    const clienteDocRefOriginal = clientesRef.doc(cedulaOriginal);
                    const clienteDoc = await transaction.get(clienteDocRefOriginal);
                    if (!clienteDoc.exists) {
                        throw new Error("El cliente original no existe.");
                    }

                    // b) Crear nuevo documento con la nueva cédula
                    const nuevoClienteData = { ...clienteDoc.data(), nombre: nombreNuevo, cedula: cedulaNueva };
                    transaction.set(clientesRef.doc(cedulaNueva), nuevoClienteData);

                    // c) Actualizar todos los préstamos asociados al ID viejo
                    const prestamosQuery = prestamosRef.where('idCliente', '==', cedulaOriginal);
                    const prestamosSnapshot = await transaction.get(prestamosQuery);

                    prestamosSnapshot.forEach(doc => {
                        transaction.update(doc.ref, { idCliente: cedulaNueva });
                    });
                    
                    // d) Eliminar el documento original
                    transaction.delete(clienteDocRefOriginal);
                });
                
                mostrarResultado('Cliente y sus préstamos actualizados a la nueva Cédula/ID.', false);
                document.getElementById('cedulaOriginal').value = cedulaNueva; // Actualiza el campo original
                document.getElementById('inputClienteId').value = cedulaNueva; // Actualiza el campo de búsqueda
                cargarReportes(cedulaNueva); // Recarga los reportes con el nuevo ID

            }
        } catch (e) {
            console.error("Error en la transacción/actualización:", e);
            mostrarResultado("Fallo al guardar cambios: " + e.message, true);
        }
    }

    // =======================================================
    // 2. LÓGICA DE REPORTES
    // =======================================================

    async function obtenerResumenPagos(idPrestamo) {
        const pagosSnapshot = await pagosRef.where('idPrestamo', '==', idPrestamo).get();
        let totalPagado = 0;
        let cuotasAbonadas = pagosSnapshot.docs.length;
        
        pagosSnapshot.forEach(doc => {
            totalPagado += doc.data().monto || 0;
        });

        return { totalPagado: totalPagado, cuotasAbonadas: cuotasAbonadas };
    }

    async function cargarReportes(idCliente) {
        document.getElementById('listadoPrestamos').innerHTML = 'Cargando préstamos...';
        document.getElementById('reportesCliente').style.display = 'block';

        let totalPagadoGlobal = 0;
        let totalSaldoPendienteGlobal = 0;
        let totalPrestamos = 0;

        try {
            const prestamosSnapshot = await prestamosRef.where('idCliente', '==', idCliente).get();
            const listadoPrestamosDiv = document.getElementById('listadoPrestamos');
            listadoPrestamosDiv.innerHTML = ''; // Limpiar

            totalPrestamos = prestamosSnapshot.docs.length;
            
            if (totalPrestamos === 0) {
                listadoPrestamosDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Este cliente no tiene préstamos activos o registrados.</p>';
            }

            for (const doc of prestamosSnapshot.docs) {
                const prestamo = doc.data();
                const idPrestamo = doc.id;

                const resumenPagos = await obtenerResumenPagos(idPrestamo);
                const saldoTotalPendiente = (prestamo.saldoPendiente || 0) + (prestamo.interesAcumulado || 0);

                totalPagadoGlobal += resumenPagos.totalPagado;
                totalSaldoPendienteGlobal += saldoTotalPendiente;
                
                const cardHTML = `
                    <div class="loan-card">
                        <h4>Préstamo ID: ${idPrestamo}
                            <span class="status-badge status-${prestamo.estado}">${prestamo.estado.toUpperCase()}</span>
                        </h4>
                        <div class="loan-stats">
                            <div class="stat-item"><strong>Capital Inicial:</strong> $${(prestamo.capitalInicial || 0).toFixed(2)}</div>
                            <div class="stat-item"><strong>Pago Diario Req:</strong> $${(prestamo.pagoDiarioRequerido || 0).toFixed(2)}</div>
                            
                            <div class="stat-item"><strong>Saldo Capital Pendiente:</strong> <span style="color: #e74c3c; font-weight: bold;">$${(prestamo.saldoPendiente || 0).toFixed(2)}</span></div>
                            <div class="stat-item"><strong>Interés Acumulado:</strong> <span style="color: #c0392b; font-weight: bold;">$${(prestamo.interesAcumulado || 0).toFixed(2)}</span></div>
                            <div class="stat-item" style="grid-column: 1 / span 2;">
                                <strong>SALDO TOTAL PENDIENTE:</strong> <span style="color: #e74c3c; font-size: 1.1em; font-weight: bold;">$${saldoTotalPendiente.toFixed(2)}</span>
                            </div>
                            
                            <div class="stat-item"><strong>Total Pagado (Cuotas):</strong> <span style="color: #2ecc71; font-weight: bold;">$${resumenPagos.totalPagado.toFixed(2)}</span></div>
                            <div class="stat-item"><strong>Cuotas Abonadas:</strong> <span style="color: #27ae60; font-weight: bold;">${resumenPagos.cuotasAbonadas}</span></div>
                            <div class="stat-item"><strong>Fecha Préstamo:</strong> ${prestamo.fechaPrestamo ? new Date(prestamo.fechaPrestamo.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                            <div class="stat-item"><strong>Último Pago:</strong> ${prestamo.fechaUltimoPago ? new Date(prestamo.fechaUltimoPago.seconds * 1000).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>
                `;
                listadoPrestamosDiv.insertAdjacentHTML('beforeend', cardHTML);
            }

            // Actualizar resumen global
            document.getElementById('totalPrestamos').textContent = totalPrestamos;
            document.getElementById('totalPagadoGlobal').textContent = `$${totalPagadoGlobal.toFixed(2)}`;
            document.getElementById('totalSaldoPendienteGlobal').textContent = `$${totalSaldoPendienteGlobal.toFixed(2)}`;

        } catch (e) {
            console.error("Error al generar reportes:", e);
            mostrarResultado("Error crítico al cargar reportes: " + e.message, true);
        }
    }
</script>

</body>
</html>
