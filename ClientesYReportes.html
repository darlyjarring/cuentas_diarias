<!DOCTYPE html>
<html>
<head>
    <title>Gestión de Clientes y Reportes Detallados</title>
    <!-- Librerías de Firebase (Clásico V8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- Tu archivo de configuración donde está la variable global 'db' -->
    <script src="firebase-config.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; padding: 30px; border-radius: 12px; background-color: #ffffff; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 30px; }
        .section-header { color: #34495e; margin-top: 25px; margin-bottom: 15px; font-size: 1.25em; border-left: 5px solid #3498db; padding-left: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-group input { flex-grow: 1; }
        button { padding: 10px 15px; background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .btn-green { background-color: #2ecc71; }
        .btn-green:hover { background-color: #27ae60; }
        .resultado { padding: 15px; border-radius: 6px; margin-top: 15px; text-align: center; font-weight: bold; }

        /* Reportes */
        #reportesCliente { margin-top: 30px; }
        .resumen-global-final { 
            border: 2px solid #2c3e50; 
            padding: 20px; 
            margin-top: 30px; 
            border-radius: 8px;
            background-color: #eaf2f8;
        }
        .resumen-global-final h3 { color: #2c3e50; margin-top: 0; }
        .loan-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 25px; border-radius: 8px; background-color: #f9f9f9; }
        .loan-card h4 { margin-top: 0; color: #3498db; }
        .loan-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em; margin-bottom: 15px;}
        .stat-item { padding: 5px 0; border-bottom: 1px dashed #eee; }
        .stat-item strong { color: #2c3e50; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; display: inline-block; margin-left: 10px; }
        .status-Activo { background-color: #f1c40f; color: #333; }
        .status-Saldado { background-color: #2ecc71; color: white; }

        /* Detalle de Pagos */
        .detalle-pagos { margin-top: 15px; background-color: #fff; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        .pago-item { padding: 3px 0; border-bottom: 1px dotted #ccc; font-size: 0.85em; }
        .pago-item:last-child { border-bottom: none; }
        .pago-item strong { margin-right: 10px; color: #555; }

        /* Estilos del Modal (Ventana Emergente) */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed; 
            z-index: 10; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); /* Fondo semi-transparente */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- Modal de Edición de Cliente -->
<div id="modalEdicionCliente" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cerrarModalEdicion()">&times;</span>
        <h3>Editar Datos del Cliente</h3>
        <input type="hidden" id="cedulaOriginal">
        <label for="editNombre">Nombre Completo:</label>
        <input type="text" id="editNombre" required>
        <label for="editCedula">Nueva Cédula/ID:</label>
        <input type="text" id="editCedula" required>
        <button onclick="guardarCambiosCliente()" class="btn-green">Guardar Cambios</button>
    </div>
</div>

<div class="container">
    <h2>Central de Gestión de Clientes y Reportes</h2>

    <!-- Sección de Búsqueda y Edición de Clientes -->
    <div class="section-header">1. Búsqueda y Modificación de Clientes</div>
    <div class="input-group">
        <input type="text" id="inputClienteId" placeholder="Ingrese ID (Cédula) del Cliente" />
        <button onclick="cargarClienteParaEdicion()">Buscar Cliente y Generar Reporte</button>
        <button id="btnEditarCliente" onclick="abrirModalEdicion()" class="btn-green" style="display:none;">
            Editar Cliente
        </button>
    </div>
    
    <!-- Sección de Reportes -->
    <div class="section-header">2. Reportes Financieros Detallados</div>
    <div id="reportesCliente" style="display:none;">
        <h3 style="color: #007bff; margin-top: 0;">=== DETALLE POR PRÉSTAMO ===</h3>
        
        <div id="listadoPrestamos">
            <!-- Las tarjetas de préstamos y el detalle de pagos se insertarán aquí -->
        </div>

        <div class="resumen-global-final">
            <h3>=== RESUMEN CONSOLIDADO DEL CLIENTE ===</h3>
            <div>- Monto Total Pagado (Histórico): <strong id="totalPagadoGlobal" style="color: #2ecc71;">$0.00</strong></div>
            <div>- Saldo Total Adeudado (Pendiente): <strong id="totalSaldoPendienteGlobal" style="color: #e74c3c;">$0.00</strong></div>
            <p style="margin-top: 15px; font-size: 0.9em; color: #7f8c8d;">(El Saldo Total Adeudado incluye Capital Pendiente + Interés Acumulado)</p>
        </div>
    </div>
    
    <div id="resultado" class="resultado"></div>
</div>

<script>
    // Variables de referencia de Firestore
    const clientesRef = typeof db !== 'undefined' ? db.collection('clientes') : null;
    const prestamosRef = typeof db !== 'undefined' ? db.collection('prestamos') : null;
    const pagosRef = typeof db !== 'undefined' ? db.collection('pagos') : null;
    let clienteSeleccionado = null;

    function mostrarResultado(mensaje, esError = false) {
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.textContent = esError ? '❌ Error: ' + mensaje : '✅ ' + mensaje;
        resultadoDiv.style.backgroundColor = esError ? '#f4cccc' : '#d9ead3';
        setTimeout(() => {
            resultadoDiv.textContent = '';
            resultadoDiv.style.backgroundColor = 'transparent';
        }, 6000);
    }

    // Función de utilidad para formatear fechas de Timestamp (ahora incluye la hora)
    function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        // Los timestamps de Firebase v8 son objetos con 'seconds'
        const date = new Date(timestamp.seconds * 1000); 
        return date.toLocaleDateString('es-ES', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit', // Añade la hora
            minute: '2-digit' // Añade el minuto
        });
    }

    // =======================================================
    // 1. LÓGICA DE EDICIÓN DE CLIENTES (CON MODAL)
    // =======================================================

    function abrirModalEdicion() {
        if (!clienteSeleccionado) {
            mostrarResultado('Primero debe buscar y cargar un cliente.', true);
            return;
        }
        document.getElementById('modalEdicionCliente').style.display = 'flex';
    }

    function cerrarModalEdicion() {
        document.getElementById('modalEdicionCliente').style.display = 'none';
    }


    async function cargarClienteParaEdicion() {
        const idCliente = document.getElementById('inputClienteId').value.trim();
        if (!idCliente) {
            mostrarResultado('Ingrese una Cédula/ID para buscar.', true);
            return;
        }

        try {
            const clienteDoc = await clientesRef.doc(idCliente).get();
            if (clienteDoc.exists) {
                clienteSeleccionado = clienteDoc.data();
                
                // Cargar datos en los campos del modal
                document.getElementById('editNombre').value = clienteSeleccionado.nombre;
                document.getElementById('editCedula').value = clienteDoc.id;
                document.getElementById('cedulaOriginal').value = clienteDoc.id; // Guarda el ID original

                // Mostrar botón de edición
                document.getElementById('btnEditarCliente').style.display = 'inline-block';

                mostrarResultado(`Cliente "${clienteSeleccionado.nombre}" cargado.`, false);
                
                // Cargar reportes del cliente
                cargarReportes(idCliente);

            } else {
                mostrarResultado('Cliente no encontrado.', true);
                document.getElementById('btnEditarCliente').style.display = 'none';
                document.getElementById('reportesCliente').style.display = 'none';
                clienteSeleccionado = null;
            }
        } catch (e) {
            console.error("Error al cargar cliente:", e);
            mostrarResultado("Error al cargar datos: " + e.message, true);
        }
    }

    async function guardarCambiosCliente() {
        const nombreNuevo = document.getElementById('editNombre').value.trim();
        const cedulaNueva = document.getElementById('editCedula').value.trim();
        const cedulaOriginal = document.getElementById('cedulaOriginal').value.trim();

        if (!nombreNuevo || !cedulaNueva) {
            mostrarResultado('Nombre y Cédula/ID son obligatorios.', true);
            return;
        }

        try {
            if (cedulaNueva === cedulaOriginal) {
                // Caso 1: Solo se actualiza el Nombre
                await clientesRef.doc(cedulaOriginal).update({ nombre: nombreNuevo });
                mostrarResultado('Nombre del cliente actualizado con éxito.', false);
            } else {
                // Caso 2: Se actualiza la Cédula/ID (Requiere transacción para mover y actualizar préstamos)
                await db.runTransaction(async (transaction) => {
                    // a) Obtener el documento original del cliente
                    const clienteDocRefOriginal = clientesRef.doc(cedulaOriginal);
                    const clienteDoc = await transaction.get(clienteDocRefOriginal);
                    if (!clienteDoc.exists) {
                        throw new Error("El cliente original no existe.");
                    }

                    // b) Crear nuevo documento con la nueva cédula
                    const nuevoClienteData = { ...clienteDoc.data(), nombre: nombreNuevo, cedula: cedulaNueva };
                    transaction.set(clientesRef.doc(cedulaNueva), nuevoClienteData);

                    // c) Actualizar todos los préstamos asociados al ID viejo
                    const prestamosQuery = prestamosRef.where('idCliente', '==', cedulaOriginal);
                    const prestamosSnapshot = await prestamosQuery.get(); 
                    
                    for (const doc of prestamosSnapshot.docs) {
                        transaction.update(doc.ref, { idCliente: cedulaNueva });
                    }
                    
                    // d) Eliminar el documento original
                    transaction.delete(clienteDocRefOriginal);
                });
                
                mostrarResultado('Cliente y sus préstamos actualizados a la nueva Cédula/ID.', false);
                document.getElementById('cedulaOriginal').value = cedulaNueva; 
                document.getElementById('inputClienteId').value = cedulaNueva; 
                cargarReportes(cedulaNueva); 

            }
            cerrarModalEdicion(); // Cierra el modal al guardar exitosamente
        } catch (e) {
            console.error("Error en la transacción/actualización:", e);
            mostrarResultado("Fallo al guardar cambios: " + e.message, true);
        }
    }

    // =======================================================
    // 2. LÓGICA DE REPORTES DETALLADOS (CON HORA Y ENCABEZADOS)
    // =======================================================

    async function obtenerDetallePagos(idPrestamo) {
        const pagosQuery = pagosRef.where('idPrestamo', '==', idPrestamo);
        const pagosSnapshot = await pagosQuery.get();
        
        let totalPagado = 0;
        let detallePagosHTML = '';
        const pagos = [];
        
        pagosSnapshot.forEach(doc => {
            const data = doc.data();
            pagos.push({
                fecha: data.fecha,
                monto: data.monto || 0
            });
            totalPagado += data.monto || 0;
        });

        // Ordenar los pagos en memoria por fecha (ascendente)
        pagos.sort((a, b) => a.fecha.seconds - b.fecha.seconds);
        
        // Generar el HTML de detalle con encabezados (estructura de grid)
        detallePagosHTML += '<div class="detalle-pagos">';
        detallePagosHTML += '<h5 style="margin-top: 0; color: #34495e;">Detalle de Pagos:</h5>';
        
        if (pagos.length === 0) {
            detallePagosHTML += '<p style="margin: 0; padding: 5px; font-style: italic;">No hay pagos registrados para este préstamo.</p>';
        } else {
            // Fila de encabezados
            detallePagosHTML += '<div style="display: grid; grid-template-columns: 2fr 1fr; font-weight: bold; border-bottom: 2px solid #ccc; padding-bottom: 5px; margin-bottom: 5px;">';
            detallePagosHTML += '<span>Fecha y Hora de Registro</span>';
            detallePagosHTML += '<span style="text-align: right;">Monto Abonado</span>';
            detallePagosHTML += '</div>';

            // Filas de pagos
            pagos.forEach(pago => {
                detallePagosHTML += `
                    <div class="pago-item" style="display: grid; grid-template-columns: 2fr 1fr;">
                        <span>- ${formatDateTime(pago.fecha)}</span> 
                        <span style="text-align: right; font-weight: bold;">$${pago.monto.toFixed(2)}</span>
                    </div>
                `;
            });
        }
        detallePagosHTML += '</div>';

        return { totalPagado: totalPagado, detalleHTML: detallePagosHTML };
    }

    async function cargarReportes(idCliente) {
        document.getElementById('listadoPrestamos').innerHTML = 'Cargando préstamos...';
        document.getElementById('reportesCliente').style.display = 'block';

        let totalPagadoGlobal = 0;
        let totalSaldoPendienteGlobal = 0;

        try {
            const prestamosSnapshot = await prestamosRef.where('idCliente', '==', idCliente).get();
            const listadoPrestamosDiv = document.getElementById('listadoPrestamos');
            listadoPrestamosDiv.innerHTML = ''; // Limpiar

            if (prestamosSnapshot.docs.length === 0) {
                listadoPrestamosDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Este cliente no tiene préstamos activos o registrados.</p>';
            }

            let prestamoIndex = 1;

            for (const doc of prestamosSnapshot.docs) {
                const prestamo = doc.data();
                const idPrestamo = doc.id;

                // 1. Obtener el detalle de pagos y el total pagado
                const { totalPagado, detalleHTML } = await obtenerDetallePagos(idPrestamo);
                
                // 2. Calcular el saldo total (Capital + Interés)
                const saldoCapitalPendiente = prestamo.saldoPendiente || 0;
                const interesAcumulado = prestamo.interesAcumulado || 0;
                const saldoTotalPendiente = saldoCapitalPendiente + interesAcumulado;

                totalPagadoGlobal += totalPagado;
                totalSaldoPendienteGlobal += saldoTotalPendiente;
                
                const cardHTML = `
                    <div class="loan-card">
                        <h4>--- Préstamo: ${prestamoIndex} (ID: ${idPrestamo})
                            <span class="status-badge status-${prestamo.estado}">${prestamo.estado.toUpperCase()}</span>
                        </h4>
                        <div class="loan-stats">
                            <div class="stat-item"><strong>Fecha Préstamo:</strong> ${formatDateTime(prestamo.fechaPrestamo)}</div>
                            <div class="stat-item"><strong>Capital Inicial:</strong> $${(prestamo.capitalInicial || 0).toFixed(2)}</div>
                            <div class="stat-item" style="grid-column: 1 / span 2; font-size: 1.1em;">
                                <strong>Total Pagado en este PRÉSTAMO:</strong> 
                                <span style="color: #2ecc71;">$${totalPagado.toFixed(2)}</span>
                            </div>
                            <div class="stat-item" style="grid-column: 1 / span 2; font-size: 1.1em;">
                                <strong>Saldo Pendiente Total:</strong> 
                                <span style="color: #e74c3c;">$${saldoTotalPendiente.toFixed(2)}</span>
                                <span style="font-size: 0.8em; color: #7f8c8d;">(Capital: $${saldoCapitalPendiente.toFixed(2)}, Interés: $${interesAcumulado.toFixed(2)})</span>
                            </div>
                        </div>
                        
                        ${detalleHTML}
                    </div>
                `;
                listadoPrestamosDiv.insertAdjacentHTML('beforeend', cardHTML);
                prestamoIndex++;
            }

            // 3. Actualizar resumen consolidado al final
            document.getElementById('totalPagadoGlobal').textContent = `$${totalPagadoGlobal.toFixed(2)}`;
            document.getElementById('totalSaldoPendienteGlobal').textContent = `$${totalSaldoPendienteGlobal.toFixed(2)}`;

        } catch (e) {
            console.error("Error al generar reportes:", e);
            mostrarResultado("Error crítico al cargar reportes: " + e.message, true);
        }
    }
</script>

</body>
</html>
