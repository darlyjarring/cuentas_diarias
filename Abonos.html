<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
        }

        .container {
            width: 380px; 
            background-color: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        label { display: block; margin-top: 10px; color: #555; }
        input, select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        button {
            width: 100%; 
            margin-top: 15px;
            padding: 10px; 
            background-color: #2c3e50;
            color: white; 
            border: none; 
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover { background-color: #1a252f; }
        #resultado {
            margin-top: 15px; 
            padding: 10px; 
            text-align: center; 
            border-radius: 6px;
        }
        #datosPrestamo {
            margin-top: 10px;
            background-color: #eef3f8;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }
        #datosPrestamo p { margin: 5px 0; }
    </style>
</head>
<body>
<div class="container">
    <h2>Registro de Pago Diario</h2>

    <label for="idPrestamo">ID del Pr√©stamo:</label>
    <input type="text" id="idPrestamo" placeholder="Ej: PREST001" onblur="buscarPrestamo()">

    <div id="datosPrestamo"></div>

    <label for="montoPagado">Monto Abonado Hoy:</label>
    <input type="number" id="montoPagado" placeholder="Ej: 100">

    <!-- üîπ Tipo de pago -->
    <label for="tipoPago">Tipo de Pago:</label>
    <select id="tipoPago">
        <option value="normal" selected>Pago normal (inter√©s + capital)</option>
        <option value="capital">Abono al capital</option>
        <option value="interes">Pago solo de inter√©s</option>
    </select>

    <button onclick="enviarPago()">Registrar Pago</button>
    <div id="resultado"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    // üîπ Configuraci√≥n Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyD3fYourKeyHere",
        authDomain: "tubasededatos.firebaseapp.com",
        projectId: "tubasededatos",
        storageBucket: "tubasededatos.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abcdefgh"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const prestamosRef = db.collection("prestamos");
    const pagosRef = db.collection("pagos");

    let idPrestamoActual = null;

    // üîç Buscar pr√©stamo y mostrar datos
    async function buscarPrestamo() {
        const id = document.getElementById("idPrestamo").value.trim().toUpperCase();
        const datosDiv = document.getElementById("datosPrestamo");
        if (!id) {
            datosDiv.style.display = "none";
            return;
        }

        try {
            const doc = await prestamosRef.doc(id).get();
            if (!doc.exists) {
                datosDiv.innerHTML = "<p style='color:red;'>‚ùå Pr√©stamo no encontrado.</p>";
                datosDiv.style.display = "block";
                return;
            }

            const data = doc.data();
            datosDiv.innerHTML = `
                <p><strong>Cliente:</strong> ${data.nombreCliente || "No registrado"}</p>
                <p><strong>Capital Inicial:</strong> $${data.capitalInicial?.toFixed(2) || 0}</p>
                <p><strong>Saldo Pendiente:</strong> $${data.saldoPendiente?.toFixed(2) || 0}</p>
                <p><strong>Inter√©s Acumulado:</strong> $${data.interesAcumulado?.toFixed(2) || 0}</p>
                <p><strong>Estado:</strong> ${data.estado || "Activo"}</p>
            `;
            datosDiv.style.display = "block";

        } catch (err) {
            console.error(err);
            datosDiv.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Error al buscar el pr√©stamo.</p>";
            datosDiv.style.display = "block";
        }
    }

    // üîÅ Actualizar intereses pendientes
    async function actualizarIntereses(idPrestamo) {
        const doc = await prestamosRef.doc(idPrestamo).get();
        if (!doc.exists) return;
        const data = doc.data();

        const hoy = new Date();
        const ultimaFecha = data.fechaUltimoPago ? data.fechaUltimoPago.toDate() : hoy;
        const mesesAtrasados = (hoy.getMonth() - ultimaFecha.getMonth()) + 12 * (hoy.getFullYear() - ultimaFecha.getFullYear());

        if (mesesAtrasados > 0 && data.estado === 'Activo') {
            const interesMensual = (data.capitalInicial || 0) * (data.porcentajeInteres || 0.02);
            const nuevoInteres = (data.interesAcumulado || 0) + (interesMensual * mesesAtrasados);

            await prestamosRef.doc(idPrestamo).update({
                interesAcumulado: parseFloat(nuevoInteres.toFixed(2))
            });
        }
    }

    // üí∞ Registrar pago
    async function enviarPago() {
        const idPrestamo = document.getElementById('idPrestamo').value.toUpperCase().trim();
        const montoPagado = parseFloat(document.getElementById('montoPagado').value);
        const tipoPago = document.getElementById('tipoPago').value;

        if (!idPrestamo || isNaN(montoPagado) || montoPagado <= 0) {
            mostrarError('Por favor, ingrese un ID de pr√©stamo y un monto v√°lido.');
            return;
        }

        idPrestamoActual = idPrestamo;
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.textContent = 'Procesando...';
        resultadoDiv.style.backgroundColor = '#fff3cd';

        try {
            await actualizarIntereses(idPrestamo);

            let nuevoSaldo = 0;
            let pagoAlCapital = 0;
            let pagoAlInteres = 0;

            await db.runTransaction(async (transaction) => {
                const prestamoDocRef = prestamosRef.doc(idPrestamo);
                const prestamoDoc = await transaction.get(prestamoDocRef);

                if (!prestamoDoc.exists) throw new Error("Pr√©stamo no encontrado.");
                const data = prestamoDoc.data();

                let saldoPendiente = data.saldoPendiente || 0;
                let interesAcumulado = data.interesAcumulado || 0;
                let capitalInicial = data.capitalInicial || 0;

                if (data.estado === 'Saldado') throw new Error("Este pr√©stamo ya fue saldado.");

                if (tipoPago === 'normal') {
                    pagoAlInteres = Math.min(montoPagado, interesAcumulado);
                    const restante = montoPagado - pagoAlInteres;
                    pagoAlCapital = Math.min(restante, saldoPendiente);
                    nuevoSaldo = saldoPendiente - pagoAlCapital;
                    interesAcumulado -= pagoAlInteres;
                } else if (tipoPago === 'capital') {
                    pagoAlCapital = Math.min(montoPagado, saldoPendiente);
                    nuevoSaldo = saldoPendiente - pagoAlCapital;
                    capitalInicial -= pagoAlCapital;
                    if (capitalInicial < 0) capitalInicial = 0;
                } else if (tipoPago === 'interes') {
                    pagoAlInteres = Math.min(montoPagado, interesAcumulado);
                    interesAcumulado -= pagoAlInteres;
                    nuevoSaldo = saldoPendiente;
                }

                if (nuevoSaldo < 0.005) nuevoSaldo = 0;
                if (interesAcumulado < 0.005) interesAcumulado = 0;

                const estado = (nuevoSaldo === 0 && interesAcumulado === 0) ? 'Saldado' : 'Activo';

                pagosRef.add({
                    idPrestamo: idPrestamo,
                    tipoPago: tipoPago,
                    monto: montoPagado,
                    fecha: firebase.firestore.FieldValue.serverTimestamp(),
                    aplicadoInteres: parseFloat(pagoAlInteres.toFixed(2)),
                    aplicadoCapital: parseFloat(pagoAlCapital.toFixed(2)),
                    saldoDespuesPago: parseFloat(nuevoSaldo.toFixed(2))
                });

                transaction.update(prestamoDocRef, {
                    saldoPendiente: parseFloat(nuevoSaldo.toFixed(2)),
                    interesAcumulado: parseFloat(interesAcumulado.toFixed(2)),
                    capitalInicial: parseFloat(capitalInicial.toFixed(2)),
                    estado: estado,
                    fechaUltimoPago: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            const mensajeFinal = `Tipo: ${tipoPago.toUpperCase()} | Capital: $${pagoAlCapital.toFixed(2)} | Inter√©s: $${pagoAlInteres.toFixed(2)} | Nuevo Saldo: $${nuevoSaldo.toFixed(2)}`;
            resultadoDiv.textContent = `‚úÖ REGISTRO GENERADO. ${mensajeFinal} (ID: ${idPrestamoActual})`;
            resultadoDiv.style.backgroundColor = '#d9ead3';

            buscarPrestamo(); // üîπ Actualiza los datos mostrados

            setTimeout(() => {
                resultadoDiv.textContent = '';
                resultadoDiv.style.backgroundColor = 'transparent';
            }, 5000);
        } catch (e) {
            console.error("Fallo de transacci√≥n:", e);
            mostrarError(e.message || "Fallo cr√≠tico al procesar el pago.");
        }
    }

    function mostrarError(msg) {
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.textContent = '‚ö†Ô∏è ' + msg;
        resultadoDiv.style.backgroundColor = '#f8d7da';
    }
</script>
</body>
</html>
