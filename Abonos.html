<!DOCTYPE html>
<html lang="es">
<head>
    <title>Registro de Pago Diario y Abonos Extraordinarios - Sistema de Préstamos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuración de colores personalizada para Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#2ecc71',
                        'primary-dark': '#27ae60',
                        'secondary': '#3498db',
                        'secondary-dark': '#2980b9',
                        'danger': '#e74c3c',
                        'danger-dark': '#c0392b',
                        'info': '#f39c12',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos base (Mínimos, el resto lo maneja Tailwind) */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; }
        .container { max-width: 750px; margin: 40px auto; padding: 30px; border-radius: 12px; background-color: #ffffff; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); }
        .resultado { padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; font-weight: bold; }
        
        /* Estilos para el Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 550px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); animation-name: animatetop; animation-duration: 0.4s; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }

        /* Animación del modal */
        @keyframes animatetop { from {top:-300px; opacity:0} to {top:10%; opacity:1} }

        /* Estilos para Grid y Responsive */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .data-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        @media (max-width: 768px) {
            .form-grid, .data-grid { grid-template-columns: 1fr; gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-3xl font-extrabold text-center">Registro de Pago Diario y Abonos</h2>

    <div class="form-grid">
        <div style="grid-column: 1 / span 2;">
            <label for="idPrestamo" class="block mb-1 font-semibold text-gray-700">ID del Préstamo:</label>
            <input type="text" id="idPrestamo" placeholder="Ej: PRST123" onchange="cargarPrestamo()" class="border p-2 rounded w-full">
        </div>
        
        <div>
            <label for="montoPagado" class="block mb-1 font-semibold text-gray-700">Monto del Pago Diario:</label>
            <input type="number" id="montoPagado" step="0.01" min="0" placeholder="Ej: 8" class="border p-2 rounded w-full">
        </div>
        
    </div>

    <div id="datosPrestamo" class="data-box bg-gray-100 p-4 rounded-lg shadow" style="display:none;">
        <h3 class="text-xl font-bold mb-3 text-gray-800 border-b pb-2">Detalles del Préstamo</h3>
        <div class="data-grid">
            <div class="flex flex-col"><strong class="text-sm text-gray-600">Cliente:</strong> <span id="nombreClientePago" class="font-medium">Cargando...</span></div>
            <div class="flex flex-col"><strong class="text-sm text-gray-600">Saldo Pendiente:</strong> <span id="saldoPendiente" class="font-extrabold text-danger text-xl"></span></div>
            <div class="flex flex-col"><strong class="text-sm text-gray-600">Pago Diario Req. Actual:</strong> <span id="pagoDiarioReq" class="font-semibold text-green-600"></span></div>
            <div class="flex flex-col"><strong class="text-sm text-gray-600">Cédula:</strong> <span id="cedulaClientePago" class="font-medium">N/A</span></div>
            <div class="flex flex-col"><strong class="text-sm text-gray-600">Interés Mensual:</strong> <span id="interesMensualTasa" class="font-extrabold text-blue-800"></span></div>
            <div class="flex flex-col col-span-1 sm:col-span-3 mt-2 pt-2 border-t border-gray-300">
                <strong class="text-sm text-gray-600">Interés Acumulado a la fecha:</strong> 
                <span id="interesAcumulado" class="font-extrabold text-indigo-700 text-lg"></span>
            </div>
        </div>
    </div>

    <div class="flex gap-4 mt-6 flex-col sm:flex-row">
        <button onclick="enviarPago()" class="w-full sm:w-1/3 py-3 rounded-lg font-bold shadow-lg transition duration-300 bg-primary hover:bg-primary-dark text-white disabled:bg-gray-400" id="btnPagoEstandar" disabled>
            1. Registrar Pago Estándar
        </button>
        <button onclick="abrirModalAbono()" class="w-full sm:w-1/3 py-3 rounded-lg font-bold shadow-lg transition duration-300 bg-info hover:bg-info/90 text-white disabled:bg-gray-400" id="btnAbonoExtraordinario" disabled>
            2. Abono Extraordinario
        </button>
        <button onclick="limpiarFormularioPagos()" class="w-full sm:w-1/3 py-3 rounded-lg font-bold shadow-md transition duration-300 bg-danger hover:bg-danger-dark text-white">
            Limpiar
        </button>
    </div>
    
    <div id="resultado" class="resultado"></div>
</div>

<div id="modalAbonoExtraordinario" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalAbono()">&times;</span>
        <h3 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Abono Extraordinario</h3>

        <div class="mb-4">
            <label for="montoAbonoExtra" class="block mb-1 font-semibold text-gray-700">Monto Total a Abonar (Extraordinario):</label>
            <input type="number" id="montoAbonoExtra" step="0.01" min="0" placeholder="Monto total del abono" class="border p-2 rounded w-full">
        </div>

        <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-info rounded">
            <label class="block mb-2 font-semibold text-gray-700">Seleccione la Estrategia de Aplicación:</label>
            <div class="space-y-2">
                <label class="block">
                    <input type="radio" name="tipoAbono" value="InteresCapital" checked class="form-radio text-primary h-4 w-4">
                    <span class="ml-2 font-medium">Priorizar Intereses (I > C) - **Recomendado para pagos regulares.**</span>
                </label>
                <label class="block">
                    <input type="radio" name="tipoAbono" value="SoloInteres" class="form-radio text-info h-4 w-4">
                    <span class="ml-2">Solo a Intereses - Pagar solo el interés acumulado.</span>
                </label>
                <label class="block">
                    <input type="radio" name="tipoAbono" value="SoloCapital" class="form-radio text-danger h-4 w-4">
                    <span class="ml-2 font-bold text-danger">Solo a Capital - Reducir la deuda principal inmediatamente.</span>
                </label>
            </div>
        </div>
        
        <div id="divNuevoPagoDiario" class="mb-6 border-t pt-4 mt-4 bg-blue-50 p-4 rounded-lg">
            <h4 class="font-bold text-gray-700 mb-2">Opción de Recálculo de Cuota</h4>
            <label for="nuevoPagoDiarioExtra" class="block mb-1 text-sm text-gray-600">Nuevo Monto de Pago Diario (Opcional):</label>
            <input type="number" id="nuevoPagoDiarioExtra" step="0.01" min="0" placeholder="Dejar en 0 si desea mantener el plazo o cuota actual" class="border p-2 rounded w-full">
            <p class="text-xs text-gray-500 mt-1">Si ingresa un valor mayor a 0, el **Pago Diario Requerido** del préstamo se actualizará (típico al bajar capital).</p>
        </div>

        <button onclick="procesarAbonoExtraordinario()" class="w-full py-3 rounded-lg font-bold text-white bg-secondary hover:bg-secondary-dark transition duration-300 shadow-lg">
            Confirmar Abono y Aplicar Cambios
        </button>
    </div>
</div>

<script type="module">
    // --- FIREBASE IMPORTS (v11/v9+ - Módulos CDN) ---
    // Usando una versión estable, puedes ajustar el número de versión si usas otra.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, runTransaction, Timestamp, serverTimestamp, setLogLevel, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURACIÓN MANDATORIA ---
    setLogLevel('debug');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

    let db;
    let prestamosCol, pagosCol, clientesCol;
    let idPrestamoActual = null;

    // Función auxiliar para construir la ruta de la colección (asume un esquema de artefactos)
    const getCollectionPath = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;

    // Inicialización y Autenticación
    window.onload = async function() {
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);

            // 1. Autenticación con Token (Si aplica) o Anónima
            if (typeof __initial_auth_token !== 'undefined') {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            
            // 2. Definición de Referencias
            prestamosCol = collection(db, getCollectionPath('prestamos'));
            pagosCol = collection(db, getCollectionPath('pagos'));
            clientesCol = collection(db, getCollectionPath('clientes'));

            console.log(`Firebase inicializado. Colecciones listas.`);

        } catch (error) {
            console.error("Error de inicialización de Firebase:", error);
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.textContent = '❌ Error de inicialización: ' + error.message;
            resultadoDiv.style.backgroundColor = '#f4cccc';
        }
    };

    // --- FUNCIONES DEL FORMULARIO Y MODAL ---

    function limpiarFormularioPagos() {
        document.getElementById('idPrestamo').value = '';
        document.getElementById('montoPagado').value = '';
        document.getElementById('datosPrestamo').style.display = 'none';
        document.getElementById('resultado').textContent = '';
        document.getElementById('resultado').style.backgroundColor = 'transparent';
        document.getElementById('btnPagoEstandar').disabled = true;
        document.getElementById('btnAbonoExtraordinario').disabled = true;
        idPrestamoActual = null;
        cargarPrestamo(); // Llama para limpiar los datos mostrados
    }
    
    window.limpiarFormularioPagos = limpiarFormularioPagos;

    function mostrarError(mensaje) {
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.textContent = '❌ Error: ' + mensaje;
        resultadoDiv.style.backgroundColor = '#f4cccc';
    }

    // Funciones de control del Modal
    function abrirModalAbono() {
        if (!idPrestamoActual) {
            mostrarError("Por favor, cargue un préstamo válido primero.");
            return;
        }
        document.getElementById('montoAbonoExtra').value = '';
        document.getElementById('nuevoPagoDiarioExtra').value = '';
        document.querySelector('input[name="tipoAbono"][value="InteresCapital"]').checked = true;
        document.getElementById('modalAbonoExtraordinario').style.display = 'block';
    }

    function cerrarModalAbono() {
        document.getElementById('modalAbonoExtraordinario').style.display = 'none';
        // Volver a cargar los datos para reflejar si hubo un recálculo
        if (idPrestamoActual) {
            cargarPrestamo(idPrestamoActual); 
        }
    }

    window.abrirModalAbono = abrirModalAbono;
    window.cerrarModalAbono = cerrarModalAbono;

    async function cargarNombreCliente(idCliente) {
        if (!clientesCol) return;
        try {
            const docRef = doc(clientesCol, idCliente);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const cliente = docSnap.data();
                document.getElementById('nombreClientePago').textContent = cliente.nombre || 'N/A';
                document.getElementById('cedulaClientePago').textContent = cliente.cedula || 'N/A';
            } else {
                document.getElementById('nombreClientePago').textContent = 'Cliente No Encontrado';
                document.getElementById('cedulaClientePago').textContent = 'N/A';
            }
        } catch (e) {
            console.error("Error al buscar cliente:", e);
        }
    }

    async function actualizarIntereses(idPrestamo) {
        // ... (Lógica para actualizar intereses se mantiene)
        if (!db) throw new Error('Error de inicialización de Firebase.');

        let datosActualizados = null;
        try {
            await runTransaction(db, async (transaction) => {
                const prestamoDocRef = doc(prestamosCol, idPrestamo);
                const prestamoDoc = await transaction.get(prestamoDocRef);

                if (!prestamoDoc.exists()) throw new Error("Préstamo no encontrado.");
                const data = prestamoDoc.data();
                if (data.estado === 'Saldado') { datosActualizados = data; return; }
                    
                const fechaCalculo = data.fechaUltimoCalculoInteres.toDate();
                // Usar saldoPendiente para la base de cálculo es más preciso en un modelo real, pero
                // mantendremos la lógica simplificada de su código anterior si ese era el requisito.
                const capitalBase = data.capitalInicial; 
                const interesTasa = data.interesTasaMensual; 
                const hoy = new Date();
                    
                let mesesTranscurridos = (hoy.getFullYear() - fechaCalculo.getFullYear()) * 12;
                mesesTranscurridos -= fechaCalculo.getMonth();
                mesesTranscurridos += hoy.getMonth();
                    
                if (hoy.getDate() < fechaCalculo.getDate()) mesesTranscurridos--;
                mesesTranscurridos = Math.max(0, mesesTranscurridos);
                    
                if (mesesTranscurridos > 0) {
                    const interesPorMes = capitalBase * interesTasa;
                    const interesTotalAñadir = interesPorMes * mesesTranscurridos;
                        
                    const nuevoInteresAcumulado = data.interesAcumulado + interesTotalAñadir;
                    const nuevaFechaCalculo = new Date(fechaCalculo);
                    nuevaFechaCalculo.setMonth(nuevaFechaCalculo.getMonth() + mesesTranscurridos);
                        
                    transaction.update(prestamoDocRef, {
                        interesAcumulado: parseFloat(nuevoInteresAcumulado.toFixed(2)),
                        fechaUltimoCalculoInteres: Timestamp.fromDate(nuevaFechaCalculo)
                    });
                        
                    datosActualizados = { ...data, interesAcumulado: parseFloat(nuevoInteresAcumulado.toFixed(2)) };
                } else {
                    datosActualizados = data;
                }
            });
            return datosActualizados;
        } catch (e) {
            throw new Error(e.message.includes("Préstamo no encontrado") ? "Préstamo no encontrado." : `Error al actualizar intereses: ${e.message}`);
        }
    }

    // --- CARGA DE PRÉSTAMO ---
    async function cargarPrestamo() {
        const idPrestamo = document.getElementById('idPrestamo').value.toUpperCase().trim();    
        document.getElementById('datosPrestamo').style.display = 'none';
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.textContent = 'Buscando y actualizando préstamo...';
        resultadoDiv.style.backgroundColor = '#fff3cd';
        
        idPrestamoActual = null; 
        document.getElementById('btnPagoEstandar').disabled = true;
        document.getElementById('btnAbonoExtraordinario').disabled = true;

        if (!idPrestamo) {
            resultadoDiv.textContent = '';
            resultadoDiv.style.backgroundColor = 'transparent';
            return;
        }

        try {
            const prestamo = await actualizarIntereses(idPrestamo);
            idPrestamoActual = idPrestamo; 

            if (prestamo) {
                document.getElementById('saldoPendiente').textContent = `$${(prestamo.saldoPendiente || 0).toFixed(2)}`;    
                document.getElementById('pagoDiarioReq').textContent = `$${(prestamo.pagoDiarioRequerido || 0).toFixed(2)}`;
                document.getElementById('interesMensualTasa').textContent = `${(prestamo.interesTasaMensual * 100).toFixed(1)}%`;
                document.getElementById('interesAcumulado').textContent = `$${(prestamo.interesAcumulado || 0).toFixed(2)}`;    
                document.getElementById('datosPrestamo').style.display = 'block';
                resultadoDiv.textContent = 'Préstamo cargado.';
                resultadoDiv.style.backgroundColor = '#d9ead3';
                document.getElementById('btnPagoEstandar').disabled = false;
                document.getElementById('btnAbonoExtraordinario').disabled = false;
                
                cargarNombreCliente(prestamo.idCliente);    
            }
        } catch (e) {
            mostrarError(e.message);
        }
    }
    window.cargarPrestamo = cargarPrestamo;


    /**
     * Función para registrar un pago normal (Usa el input de la pantalla principal)
     */
    async function enviarPago() {
        if (!idPrestamoActual) {
            mostrarError("Primero debe cargar un préstamo válido.");
            return;
        }
        const montoPagado = parseFloat(document.getElementById('montoPagado').value);

        if (isNaN(montoPagado) || montoPagado <= 0) {
            mostrarError('Por favor, ingrese un monto válido (mayor a 0) en el campo de Pago Diario.');
            return;
        }

        await procesarTransaccion({ 
            idPrestamo: idPrestamoActual, 
            montoPagado: montoPagado, 
            tipoAbono: 'InteresCapital', // Estándar I > C
            esExtraordinario: false
        });
    }
    window.enviarPago = enviarPago;


    /**
     * FUNCIÓN NUEVA: Procesa el abono desde la ventana modal.
     */
    async function procesarAbonoExtraordinario() {
        const montoPagado = parseFloat(document.getElementById('montoAbonoExtra').value);
        const nuevoPagoDiario = parseFloat(document.getElementById('nuevoPagoDiarioExtra').value) || 0;
        const tipoAbono = document.querySelector('input[name="tipoAbono"]:checked').value;

        if (isNaN(montoPagado) || montoPagado <= 0) {
            mostrarError('Por favor, ingrese un monto válido (mayor a 0) para el abono extraordinario.');
            return;
        }

        cerrarModalAbono(); // Cerrar el modal antes de la transacción.
        
        await procesarTransaccion({ 
            idPrestamo: idPrestamoActual, 
            montoPagado: montoPagado, 
            tipoAbono: tipoAbono, 
            nuevoPagoDiario: nuevoPagoDiario,
            esExtraordinario: true
        });
    }
    window.procesarAbonoExtraordinario = procesarAbonoExtraordinario;


    /**
     * Función centralizada para manejar todas las transacciones de pago.
     */
    async function procesarTransaccion({ idPrestamo, montoPagado, tipoAbono, nuevoPagoDiario = 0, esExtraordinario = false }) {
        if (!db) { mostrarError('Base de datos no inicializada.'); return; }
        
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.textContent = `Procesando pago... (${tipoAbono})`;
        resultadoDiv.style.backgroundColor = esExtraordinario ? '#d4e7f7' : '#fff3cd';    
        
        try {
            // 1. Asegurar que los intereses estén actualizados
            await actualizarIntereses(idPrestamo);
            
            let pagoAlCapital = 0;
            let pagoAlInteres = 0;
            let nuevoSaldo = 0;
            let pagoDiarioAnterior = 0;

            // 2. Transacción de Pago
            await runTransaction(db, async (transaction) => {
                const prestamoDocRef = doc(prestamosCol, idPrestamo);
                const prestamoDoc = await transaction.get(prestamoDocRef);
                
                const data = prestamoDoc.data();
                let saldoPendiente = data.saldoPendiente || 0;
                let interesAcumulado = data.interesAcumulado || 0;
                pagoDiarioAnterior = data.pagoDiarioRequerido || 0;
                
                if (saldoPendiente <= 0 && interesAcumulado <= 0) throw new Error("Este préstamo ya ha sido liquidado.");

                let restante = montoPagado;

                // LÓGICA DE APLICACIÓN SEGÚN EL TIPO DE ABONO
                switch (tipoAbono) {
                    case 'SoloInteres':
                        pagoAlInteres = Math.min(restante, interesAcumulado);
                        pagoAlCapital = 0;
                        break;

                    case 'SoloCapital':
                        pagoAlCapital = Math.min(restante, saldoPendiente);
                        pagoAlInteres = 0;
                        break;

                    case 'InteresCapital':
                    default:
                        pagoAlInteres = Math.min(restante, interesAcumulado);
                        restante -= pagoAlInteres;
                        pagoAlCapital = Math.min(restante, saldoPendiente);
                        break;
                }
                
                nuevoSaldo = saldoPendiente - pagoAlCapital;
                let nuevoInteresAcumulado = interesAcumulado - pagoAlInteres;

                if (nuevoSaldo < 0) nuevoSaldo = 0;
                if (nuevoInteresAcumulado < 0.005) nuevoInteresAcumulado = 0; // Evitar negativos por flotantes

                const estado = (nuevoSaldo === 0 && nuevoInteresAcumulado === 0) ? 'Saldado' : 'Activo';
                
                // A. Registro del pago
                await addDoc(pagosCol, {
                    idPrestamo: idPrestamo,
                    monto: montoPagado,
                    fecha: serverTimestamp(), 
                    aplicadoInteres: parseFloat(pagoAlInteres.toFixed(2)),
                    aplicadoCapital: parseFloat(pagoAlCapital.toFixed(2)),
                    saldoDespuesPago: parseFloat(nuevoSaldo.toFixed(2)),
                    tipoOperacion: esExtraordinario ? 'Extraordinario' : 'Diario',
                    estrategiaAbono: tipoAbono
                });
                
                // B. Preparar actualización del préstamo
                const updateData = {
                    saldoPendiente: parseFloat(nuevoSaldo.toFixed(2)),
                    interesAcumulado: parseFloat(nuevoInteresAcumulado.toFixed(2)),
                    estado: estado,
                    fechaUltimoPago: serverTimestamp(),
                };

                // Aplicar el recálculo si aplica (solo en abono extraordinario)
                if (esExtraordinario && nuevoPagoDiario > 0) {
                    updateData.pagoDiarioRequerido = parseFloat(nuevoPagoDiario.toFixed(2));
                }

                // C. Actualización del préstamo
                transaction.update(prestamoDocRef, updateData);
            });

            // 3. MOSTRAR ÉXITO
            let mensajeTipo = esExtraordinario ? `ABONO EXTRAORDINARIO (${tipoAbono})` : 'PAGO DIARIO ESTÁNDAR';
            let mensajeCuota = (esExtraordinario && nuevoPagoDiario > 0) 
                ? `Cuota Anterior: $${pagoDiarioAnterior.toFixed(2)}. ¡CUOTA ACTUALIZADA a $${nuevoPagoDiario.toFixed(2)}!`
                : '';

            const mensajeFinal = `${mensajeTipo} registrado. Capital: $${pagoAlCapital.toFixed(2)}, Interés: $${pagoAlInteres.toFixed(2)}. Nuevo Saldo: $${nuevoSaldo.toFixed(2)}. ${mensajeCuota}`;
            
            resultadoDiv.textContent = `✅ ÉXITO. ${mensajeFinal}`;
            resultadoDiv.style.backgroundColor = '#d9ead3';

            // Limpiar inputs
            document.getElementById('montoPagado').value = ''; 
            
            setTimeout(() => {
                resultadoDiv.textContent = '';
                resultadoDiv.style.backgroundColor = 'transparent';
                cargarPrestamo(); 
            }, 8000);
            
        } catch (e) {
            console.error("Fallo de transacción:", e);
            mostrarError(e.message || "Fallo crítico al procesar la operación.");
            cargarPrestamo(); 
        }
    }
</script>

</body>
</html>
