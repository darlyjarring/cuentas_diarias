<!DOCTYPE html>
<html>
<head>
    <title>Registro de Pagos y Abono a Capital</title>
    <!-- Cargamos Tailwind CSS para un diseño limpio -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #eef2f5; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 25px; }
        .input-group { display: flex; gap: 10px; }
        input[type="text"], input[type="number"] { border: 1px solid #ccc; padding: 10px; border-radius: 8px; transition: border-color 0.3s; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: #3b82f6; outline: none; }
        button { cursor: pointer; transition: background-color 0.3s, transform 0.1s; border-radius: 8px; padding: 10px 15px; }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .status-Activo { color: #f97316; font-weight: bold; }
        .status-Saldado { color: #10b981; font-weight: bold; }
        /* Estilos para el modal/message box (sustituto de alert/confirm) */
        .message-box { 
            position: fixed; top: 20px; right: 20px; z-index: 50; 
            padding: 15px 25px; border-radius: 8px; font-weight: 600; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); 
            display: none; 
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.success { background-color: #d1fae5; color: #065f46; }
        .message-box.error { background-color: #fee2e2; color: #991b1b; }
    </style>
    <!-- Importaciones de Firebase V9 (Módulos) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, addDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        let app, db, auth;
        
        // --- CONFIGURACIÓN DE FIREBASE DEL USUARIO (Hardcodeada para garantizar conexión) ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCuGggEvH6leC6-tWBpN-5BXC37U-NsFqU",
            authDomain: "finanzas-excel30.firebaseapp.com",
            projectId: "finanzas-excel30",
            storageBucket: "finanzas-excel30.firebasestorage.app",
            messagingSenderId: "508931220293",
            appId: "1:508931220293:web:d64cf5125c37d5bae3142c",
            measurementId: "G-2YZ3YREX0P"
        };
        
        try {
            // 1. Inicializar App con la configuración incrustada
            app = initializeApp(USER_FIREBASE_CONFIG);
            // 2. Inicializar Firestore y Auth con el método V9
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase App y Firestore V9 inicializados correctamente.");
        } catch (e) {
            console.error("ERROR FATAL: Fallo al inicializar Firebase con la configuración proporcionada.", e);
        }

        // --- EXPOSICIÓN DE GLOBALES (Solo si se inicializó correctamente) ---
        if (db && auth) {
            window.db = db;
            window.auth = auth;
            // La variable appId es necesaria para construir la ruta de Firestore
            window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            window.COLLECTION_PRESTAMOS = 'prestamos';
            window.COLLECTION_PAGOS = 'pagos';
            window.serverTimestamp = serverTimestamp;
            window.runTransaction = runTransaction;
            window.getDoc = getDoc;
            window.doc = doc;
            window.updateDoc = updateDoc;
            window.collection = collection;
            window.query = query;
            window.where = where;
            window.addDoc = addDoc;
        }

        // Iniciar autenticación
        async function initializeAuth() {
            if (!auth) {
                console.warn("Auth no inicializado. No se puede autenticar.");
                return;
            }
            try {
                // Si el token personalizado está disponible, úselo (método preferido)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Firebase Auth iniciado con token personalizado.");
                } else {
                    // Si el token personalizado no está disponible, se intenta la autenticación anónima
                    await signInAnonymously(auth); 
                    console.log("Firebase Auth iniciado de forma anónima.");
                }
            } catch (error) {
                // Este error indica que la Autenticación Anónima está deshabilitada en la consola de Firebase.
                if (error.code === 'auth/admin-restricted-operation') {
                    console.error("ERROR DE AUTENTICACIÓN: La Autenticación Anónima (Anonymous) está deshabilitada en su Consola de Firebase. Por favor, habilítela.");
                }
                console.error("Error en la autenticación:", error);
            }
        }
        initializeAuth();
    </script>
</head>
<body class="p-8">

    <div id="messageBox" class="message-box" style="display: none;"></div>

    <div class="max-w-4xl mx-auto space-y-8">
        <h2 class="text-3xl font-extrabold text-gray-800 border-b-4 border-blue-500 pb-2">
            Gestión de Pagos y Abonos a Capital
        </h2>

        <!-- Sección de Búsqueda de Préstamo -->
        <div class="card p-6">
            <h3 class="text-xl font-semibold mb-4 text-blue-600">1. Buscar Préstamo por ID</h3>
            <div class="input-group">
                <input type="text" id="inputPrestamoId" class="w-full" placeholder="Ingrese ID del Préstamo (ej: aB1cD2eF3g)" />
                <button onclick="buscarPrestamo()" class="btn-primary flex-shrink-0">Cargar Préstamo</button>
            </div>
        </div>

        <!-- Resultados y Operaciones -->
        <div id="prestamoInfo" class="card p-6" style="display: none;">
            <h3 class="text-xl font-semibold mb-4 text-gray-700">2. Detalles del Préstamo</h3>
            
            <div class="space-y-2 text-sm text-gray-600 mb-6 border-b pb-4">
                <p><strong>ID Cliente:</strong> <span id="infoIdCliente" class="font-medium"></span></p>
                <p><strong>Capital Inicial:</strong> $<span id="infoCapitalInicial" class="font-medium"></span></p>
                <p><strong>Capital Pendiente:</strong> $<span id="infoCapitalPendiente" class="font-medium text-red-600"></span></p>
                <p><strong>Pago Diario Requerido:</strong> $<span id="infoPagoDiario" class="font-medium text-blue-600"></span></p>
                <p><strong>Tasa Interés Diaria:</strong> <span id="infoTasaInteres" class="font-medium"></span>%</p>
                <p><strong>Estado:</strong> <span id="infoEstado"></span></p>
            </div>

            <!-- Sección de Abono Normal (Diario) -->
            <div class="border border-gray-200 p-4 rounded-lg mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-700">Abono Diario o Parcial</h4>
                <div class="input-group">
                    <input type="number" id="montoPagoDiario" class="w-full" placeholder="Monto del Abono (ej: 15.00)" min="0" step="0.01" />
                    <button onclick="realizarAbono(false)" class="btn-primary flex-shrink-0">Registrar Abono Diario</button>
                </div>
            </div>

            <!-- Sección de Abono a Capital (Nuevo) -->
            <div class="border border-green-500 bg-green-50 p-4 rounded-lg">
                <h4 class="text-lg font-bold mb-3 text-green-700">Abono Directo a Capital Inicial</h4>
                <p class="text-sm text-green-800 mb-3">Este abono reduce directamente el capital pendiente y recalcula la nueva cuota diaria, tras pagar el interés acumulado.</p>
                <div class="input-group">
                    <input type="number" id="montoAbonoCapital" class="w-full" placeholder="Monto Total a Abonar (ej: 50.00)" min="0" step="0.01" />
                    <button onclick="realizarAbono(true)" class="btn-success flex-shrink-0">
                        Abonar a Capital
                    </button>
                </div>
            </div>
        </div>

    </div>

<script>
    // La variable appId ahora se inicializa dentro del bloque type="module"
    let prestamoActual = null;
    let prestamoDocRef = null;

    // --- Utilidades ---

    function mostrarMensaje(mensaje, tipo) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = mensaje;
        messageBox.className = `message-box ${tipo}`;
        messageBox.style.display = 'block';
        messageBox.style.opacity = 1;

        setTimeout(() => {
            messageBox.style.opacity = 0;
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 300);
        }, 5000);
    }

    function formatCurrency(amount) {
        return parseFloat(amount).toFixed(2);
    }

    function calculateDaysPassed(timestamp) {
        if (!timestamp || !timestamp.toDate) return 0; // Verifica que sea un Timestamp V9 válido
        const lastDate = timestamp.toDate();
        const now = new Date();
        
        // La diferencia de tiempo en milisegundos
        const diffTime = now.getTime() - lastDate.getTime(); 
        
        // Días completos que han pasado
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        // Si el último pago fue hoy, devuelve 0. Si fue ayer, devuelve 1.
        return Math.max(0, diffDays); 
    }

    // --- Lógica de Búsqueda ---

    async function buscarPrestamo() {
        // Validación de conexión
        if (typeof window.db === 'undefined' || window.db === null) {
            mostrarMensaje('¡ERROR DE CONEXIÓN! La base de datos no está inicializada. Revise la consola para detalles de configuración.', 'error');
            return;
        }
        
        const id = document.getElementById('inputPrestamoId').value.trim();
        if (!id) {
            mostrarMensaje('Por favor, ingrese el ID del Préstamo.', 'error');
            return;
        }

        try {
            // Ruta: /artifacts/{appId}/public/data/prestamos/{id}
            prestamoDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', window.COLLECTION_PRESTAMOS, id);
            
            const prestamoDoc = await window.getDoc(prestamoDocRef);

            if (prestamoDoc.exists()) {
                prestamoActual = prestamoDoc.data();
                if (prestamoActual.estado === 'Saldado') {
                    mostrarMensaje('Este préstamo ya está Saldado.', 'error');
                }
                
                // Mostrar información en la UI
                document.getElementById('infoIdCliente').textContent = prestamoActual.idCliente || 'N/A';
                document.getElementById('infoCapitalInicial').textContent = formatCurrency(prestamoActual.capitalInicial || 0);
                document.getElementById('infoCapitalPendiente').textContent = formatCurrency(prestamoActual.saldoPendiente || 0);
                document.getElementById('infoPagoDiario').textContent = formatCurrency(prestamoActual.pagoDiarioRequerido || 0);
                document.getElementById('infoTasaInteres').textContent = formatCurrency((prestamoActual.tasaInteresDiaria || 0) * 100);
                
                const estadoSpan = document.getElementById('infoEstado');
                estadoSpan.textContent = prestamoActual.estado;
                estadoSpan.className = `status-${prestamoActual.estado}`;
                
                document.getElementById('prestamoInfo').style.display = 'block';
                mostrarMensaje('Préstamo cargado con éxito.', 'success');
            } else {
                mostrarMensaje(`Préstamo con ID ${id} no encontrado.`, 'error');
                document.getElementById('prestamoInfo').style.display = 'none';
                prestamoActual = null;
                prestamoDocRef = null;
            }
        } catch (error) {
            console.error("Error al buscar préstamo:", error);
            mostrarMensaje(`Error al cargar: ${error.message || 'Verifique la conexión y el ID.'}`, 'error');
        }
    }


    // --- Lógica de Abono Normal y Abono a Capital ---

    async function realizarAbono(esAbonoCapital) {
        if (!prestamoActual || !prestamoDocRef) {
            mostrarMensaje('Primero debe cargar un préstamo válido.', 'error');
            return;
        }

        const inputId = esAbonoCapital ? 'montoAbonoCapital' : 'montoPagoDiario';
        const montoTotalAbono = parseFloat(document.getElementById(inputId).value);

        if (isNaN(montoTotalAbono) || montoTotalAbono <= 0) {
            mostrarMensaje('Ingrese un monto válido mayor a cero.', 'error');
            return;
        }

        try {
            // Usamos una transacción para garantizar la atomicidad de las operaciones
            await window.runTransaction(window.db, async (transaction) => {
                // 1. Re-leer el documento dentro de la transacción
                const prestamoDoc = await transaction.get(prestamoDocRef);
                if (!prestamoDoc.exists()) {
                    throw new Error("El préstamo fue eliminado o no existe.");
                }
                let data = prestamoDoc.data();
                
                // Variables iniciales
                let saldoPendienteActual = data.saldoPendiente;
                const tasaDiaria = data.tasaInteresDiaria || 0;
                const tasaTotal = data.tasaTotal || 0; // Tasa total usada para recalculo (e.g. 0.2 para 20%)
                const diasPlazo = data.diasPlazo || 1; // Días del plazo original
                let fechaUltimoPago = data.fechaUltimoPago;
                let capitalReducido = 0;
                let interesGenerado = 0; // Interés que se generó hasta hoy
                let interesPagado = 0; // Interés que se cubre con este abono
                let abonoCapital = 0;
                let nuevoPagoDiarioRequerido = data.pagoDiarioRequerido;
                let nuevoEstado = data.estado;

                // --- CALCULAR INTERÉS GENERADO DESDE EL ÚLTIMO PAGO ---
                const diasPasados = calculateDaysPassed(fechaUltimoPago);
                
                if (diasPasados > 0 && saldoPendienteActual > 0) {
                    interesGenerado = saldoPendienteActual * tasaDiaria * diasPasados;
                }
                
                let restante = montoTotalAbono;
                
                if (esAbonoCapital) {
                    // --- Lógica de Abono a Capital ---
                    
                    // 1. Pagar el interés generado (obligatorio en abono a capital)
                    if (restante < interesGenerado) {
                        throw new Error(`El abono ($${formatCurrency(restante)}) es menor al interés generado ($${formatCurrency(interesGenerado)}) y no puede aplicarse a capital.`); 
                    }

                    interesPagado = interesGenerado;
                    restante -= interesGenerado;

                    // 2. El resto se aplica al Capital
                    abonoCapital = Math.min(restante, saldoPendienteActual);
                    saldoPendienteActual -= abonoCapital;
                    capitalReducido = abonoCapital;

                    // 3. Recalcular la Cuota Diaria
                    if (diasPlazo > 0) {
                        // Nuevo Pago Diario = (Nuevo Capital Pendiente * (1 + Tasa Total)) / Días Plazo Original
                        // Asumimos que la amortización restante se distribuye en el plazo original
                        const nuevoMontoTotal = saldoPendienteActual * (1 + tasaTotal);
                        nuevoPagoDiarioRequerido = nuevoMontoTotal / diasPlazo;
                    } else {
                        nuevoPagoDiarioRequerido = saldoPendienteActual > 0 ? nuevoPagoDiarioRequerido : 0;
                    }
                    
                    // 4. Actualizar data
                    data.pagoDiarioRequerido = nuevoPagoDiarioRequerido;
                    
                } else {
                    // --- Lógica de Abono Diario Normal ---

                    // 1. El pago primero cubre interés generado
                    interesPagado = Math.min(restante, interesGenerado);
                    restante -= interesPagado;
                    
                    // 2. El resto se aplica al capital
                    abonoCapital = Math.min(restante, saldoPendienteActual);
                    saldoPendienteActual -= abonoCapital;
                    capitalReducido = abonoCapital;
                }

                // 5. Determinar el nuevo estado y actualizar saldo
                if (saldoPendienteActual <= 0) {
                    nuevoEstado = 'Saldado';
                    saldoPendienteActual = 0;
                    nuevoPagoDiarioRequerido = 0;
                    data.estado = nuevoEstado;
                    data.pagoDiarioRequerido = nuevoPagoDiarioRequerido;
                }

                data.saldoPendiente = saldoPendienteActual;
                data.fechaUltimoPago = window.serverTimestamp(); // La fecha del pago es AHORA

                // --- GUARDAR CAMBIOS EN EL PRÉSTAMO (TRANSACCIÓN) ---
                transaction.update(prestamoDocRef, data);
                
                // --- REGISTRAR PAGO (colección 'pagos') ---
                const pagosCollectionRef = window.collection(window.db, 'artifacts', window.appId, 'public', 'data', window.COLLECTION_PAGOS);
                
                // Agregamos el documento de pago fuera de la transacción (V9 no permite addDoc dentro)
                await window.addDoc(pagosCollectionRef, {
                    idPrestamo: prestamoDoc.id,
                    idCliente: data.idCliente,
                    monto: montoTotalAbono, 
                    montoAplicadoCapital: capitalReducido,
                    montoAplicadoInteres: interesPagado,
                    interesGeneradoHoy: interesGenerado,
                    tipo: esAbonoCapital ? 'Abono a Capital (Recalculado)' : 'Abono Diario',
                    fecha: window.serverTimestamp()
                });

                // 6. Reporte de éxito
                const mensaje = `Transacción (${esAbonoCapital ? 'Abono a Capital' : 'Abono Diario'}) registrada. 
                                 Interés generado/cubierto: $${formatCurrency(interesGenerado)}. 
                                 Abono a capital: $${formatCurrency(capitalReducido)}.
                                 Nuevo pago diario: $${formatCurrency(data.pagoDiarioRequerido)}.`;
                mostrarMensaje(mensaje, 'success');
                
            });

            // Recargar la UI
            await buscarPrestamo(); 

        } catch (error) {
            console.error("Error en la transacción de pago:", error);
            mostrarMensaje(`Fallo al realizar el pago: ${error.message || 'Error desconocido en Firestore.'}`, 'error');
        }
    }
</script>

</body>
</html>
