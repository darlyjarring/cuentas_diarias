<!DOCTYPE html>
<html>
<head>
    <title>Registro de Préstamo - Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; color: #333; }
        .container { max-width: 650px; margin: 40px auto; padding: 30px; border: 1px solid #e0e0e0; border-radius: 12px; background-color: #ffffff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
        h2 { color: #2c3e50; margin-bottom: 25px; text-align: center; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"], input[type="date"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        button { width: 100%; padding: 12px; background-color: #3498db; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .resultado { padding: 15px; border-radius: 6px; margin-top: 20px; text-align: center; font-weight: bold; }
        .btn-green { background-color: #2ecc71; }
        .btn-green:hover { background-color: #27ae60; }
        .btn-red { background-color: #e74c3c; }
        .btn-red:hover { background-color: #c0392b; }
    </style>
</head>
<body>

<div class="container">
    <h2>Registro de Nuevo Préstamo</h2>

    <div class="form-grid">
        <div style="grid-column: 1 / span 2; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 10px;">
            <h3 style="margin: 0; color: #34495e;">Datos del Cliente</h3>
        </div>
        <div>
            <label for="idCliente">ID del Cliente (Cédula/DNI):</label>
            <input type="text" id="idCliente" placeholder="Cédula">
        </div>
        <div>
            <label for="nombreCliente">Nombre Completo:</label>
            <input type="text" id="nombreCliente" placeholder="Juan Pérez">
        </div>
        
        <div style="grid-column: 1 / span 2; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-top: 10px;">
            <h3 style="margin: 0; color: #34495e;">Condiciones del Préstamo</h3>
        </div>
        <div>
            <label for="capitalInicial">Capital Inicial ($):</label>
            <input type="number" id="capitalInicial" step="0.01" min="0" placeholder="100.00">
        </div>
        <div>
            <label for="pagoDiarioReq">Pago Diario Requerido ($):</label>
            <input type="number" id="pagoDiarioReq" step="0.01" min="0" placeholder="5.00">
        </div>
        
        <div>
            <label for="fechaPrestamo">Fecha del Préstamo:</label>
            <input type="date" id="fechaPrestamo">
        </div>
        <div>
            <label for="tasaInteresMensual">Tasa Interés Mensual (%):</label>
            <input type="number" id="tasaInteresMensual" value="20.0" step="0.1" min="0" readonly title="Fijo en 20% según la política">
        </div>
        
    </div>

    <button onclick="registrarPrestamo()" class="btn-green">
        Registrar Préstamo
    </button>
    
    <div id="resultadoPrestamo" class="resultado"></div>
</div>

<script>
    // Se define la función de utilidad para mostrar mensajes
    function mostrarResultado(mensaje, esError = false) {
        const resultadoDiv = document.getElementById('resultadoPrestamo');
        resultadoDiv.textContent = esError ? '❌ Error: ' + mensaje : '✅ ' + mensaje;
        resultadoDiv.style.backgroundColor = esError ? '#f4cccc' : '#d9ead3';
        setTimeout(() => {
            resultadoDiv.textContent = '';
            resultadoDiv.style.backgroundColor = 'transparent';
        }, 5000);
    }

    // Se define la función para generar IDs
    function generarIdPrestamo() {
        // Genera un ID simple y único (ej: PRST + timestamp corto)
        return 'PRST' + Date.now().toString().slice(-6);
    }

    // Función principal para registrar el préstamo
    async function registrarPrestamo() {
        // Se definen las referencias a las colecciones DENTRO DE LA FUNCIÓN para asegurar que 'db' está disponible.
        if (typeof db === 'undefined') {
            mostrarResultado('Error de inicialización de Firebase. La variable "db" no está definida.', true);
            return;
        }
        
        const prestamosRef = db.collection('prestamos');
        const clientesRef = db.collection('clientes');

        const idCliente = document.getElementById('idCliente').value.trim();
        const nombreCliente = document.getElementById('nombreCliente').value.trim();
        const capitalInicial = parseFloat(document.getElementById('capitalInicial').value);
        const pagoDiarioReq = parseFloat(document.getElementById('pagoDiarioReq').value);
        const fechaPrestamoStr = document.getElementById('fechaPrestamo').value;
        const tasaInteresMensual = parseFloat(document.getElementById('tasaInteresMensual').value) / 100; // 0.20

        if (!idCliente || !nombreCliente || isNaN(capitalInicial) || isNaN(pagoDiarioReq) || !fechaPrestamoStr || isNaN(tasaInteresMensual)) {
            mostrarResultado('Por favor, complete todos los campos con valores válidos.', true);
            return;
        }

        const idPrestamo = generarIdPrestamo();
        const fechaPrestamo = new Date(fechaPrestamoStr);
        
        const prestamoData = {
            idCliente: idCliente,
            idPrestamo: idPrestamo,
            // Guardamos la fecha como Timestamp de Firestore para cálculos posteriores
            fechaPrestamo: firebase.firestore.Timestamp.fromDate(fechaPrestamo), 
            capitalInicial: capitalInicial,
            pagoDiarioRequerido: pagoDiarioReq,
            saldoPendiente: capitalInicial, // Al inicio, es igual al capital
            
            // --- CAMPOS DE INTERÉS ---
            interesTasaMensual: tasaInteresMensual, // 0.20
            interesAcumulado: 0.00, // Comienza en cero
            
            // La fecha en la que se calculó el último interés (inicialmente es la fecha del préstamo)
            fechaUltimoCalculoInteres: firebase.firestore.Timestamp.fromDate(fechaPrestamo), 
            // --- FIN CAMPOS DE INTERÉS ---
            
            diasAtrasoAcumulado: 0,
            estado: 'Activo',
            fechaUltimoPago: firebase.firestore.Timestamp.fromDate(fechaPrestamo),
        };
        
        const clienteData = {
            nombre: nombreCliente,
            cedula: idCliente,
            fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            // 1. Guardar/Actualizar Cliente
            await clientesRef.doc(idCliente).set(clienteData, { merge: true });
            
            // 2. Guardar Préstamo
            await prestamosRef.doc(idPrestamo).set(prestamoData);
            
            mostrarResultado(`Préstamo registrado con éxito. ID Préstamo: ${idPrestamo}`);
            // Limpiar campos de préstamo
            document.getElementById('capitalInicial').value = '';
            document.getElementById('pagoDiarioReq').value = '';
        } catch (e) {
            console.error("Error al registrar préstamo:", e);
            mostrarResultado("Fallo al registrar el préstamo: " + e.message, true);
        }
    }
</script>

</body>
</html>
