<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Administraci√≥n de Pagos (Test)</title>
<style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f7f8;padding:20px;}
    .box{max-width:550px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08);}
    h2{text-align:center;color:#8B0000;margin-bottom:20px; border-bottom: 2px solid #8B0000; padding-bottom: 10px;}
    h3{color:#333; margin-top: 10px; margin-bottom: 10px;}
    label{display:block;margin-top:12px;color:#333;font-weight:600}
    input{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
    button{margin-top:16px;width:100%;padding:12px;border-radius:6px;border:none;background:#8B0000;color:#fff;cursor:pointer;font-weight:bold;transition:background .3s}
    button:hover{background:#A52A2A}
    .warn{background:#fff3cd;color:#856404; margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center;}
    .err{background:#f8d7da;color:#721c24; margin-top: 15px; padding: 10px; border-radius: 6px;}
    .info{background:#d1ecf1;color:#0c5460; margin-top: 15px; padding: 10px; border-radius: 6px;}
    
    .pago-item {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        cursor: pointer;
        background: #f9f9f9;
        transition: background 0.2s;
    }
    .pago-item:hover {
        background: #e6e6e6;
        border-color: #8B0000;
    }
</style>
</head>
<body>
<div class="box">
    <h2>üõ†Ô∏è Herramienta de Correcci√≥n de Pagos (Admin)</h2>
    
    <label for="idPrestamoAdmin">ID del Pr√©stamo a Consultar</label>
    <input id="idPrestamoAdmin" placeholder="Ej: PREST001" />

    <button onclick="buscarPagos()">Buscar Pagos del Pr√©stamo</button>

    <div id="resultadoAdmin" class="resultado"></div>
    
    <div id="listaPagosDiv" style="margin-top: 20px;">
        <!-- Pagos listados aqu√≠ -->
    </div>
    
    <div id="formularioCorreccion" style="border-top: 1px solid #ddd; padding-top: 20px; margin-top: 20px; display: none;">
        <h3>Datos del Pago Seleccionado</h3>
        <p class="warn">
            Advertencia: El cambio solo se aplica al registro de pago. No recalcula el saldo del pr√©stamo.
        </p>
        <p>ID de Pago Seleccionado: <strong id="pagoSeleccionadoID">--</strong></p>
        
        <label for="montoAdmin">Nuevo Monto Pagado</label>
        <input id="montoAdmin" type="number" step="0.01" />

        <label for="fechaAdmin">Nueva Fecha de Pago</label>
        <input id="fechaAdmin" type="date" />

        <button id="btnCorregirPago" onclick="corregirPago()">Guardar Correcci√≥n</button>
    </div>
</div>

<!-- Firebase v8 CDN -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
/* ============ CONFIGURA AQU√ç ============ */
const firebaseConfig = {
    // Reemplaza con tus datos de configuraci√≥n reales
    apiKey: "AIzaSyCuGggEvH6leC6-tWBpN-5BXC37U-NsFqU",
    authDomain: "finanzas-excel30.firebaseapp.com",
    projectId: "finanzas-excel30",
    storageBucket: "finanzas-excel30.firebasestorage.app",
    messagingSenderId: "508931220293",
    appId: "1:508931220293:web:d64cf5125c37d5bae3142c",
    measurementId: "G-2YZ3YREX0P"
};
/* ======================================== */

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const pagosRef = db.collection('pagos');

const resultadoAdminDiv = document.getElementById('resultadoAdmin');
const listaPagosDiv = document.getElementById('listaPagosDiv');
const formularioCorreccionDiv = document.getElementById('formularioCorreccion');
const pagoSeleccionadoIDStrong = document.getElementById('pagoSeleccionadoID');

let idPagoSeleccionado = null; // Variable global para el ID de pago seleccionado

// Funciones de utilidad para el panel de administraci√≥n
function mostrarAdminInfo(text){resultadoAdminDiv.textContent=text;resultadoAdminDiv.className='info';}
function mostrarAdminError(text){resultadoAdminDiv.textContent=text;resultadoAdminDiv.className='err';}

// Funci√≥n auxiliar para formatear la fecha para la visualizaci√≥n
function formatDate(timestamp) {
    if (timestamp && typeof timestamp.toDate === 'function') {
        return timestamp.toDate().toLocaleDateString('es-ES', { 
            year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit' 
        });
    }
    return 'Fecha N/A';
}

// Funci√≥n auxiliar para obtener la fecha en formato YYYY-MM-DD para el input[type="date"]
function dateToInput(timestamp) {
    if (timestamp && typeof timestamp.toDate === 'function') {
        const date = timestamp.toDate();
        return date.toISOString().split('T')[0];
    }
    return '';
}

// === L√ìGICA DE B√öSQUEDA DE PAGOS POR PR√âSTAMO ===
async function buscarPagos() {
    const idPrestamo = (document.getElementById('idPrestamoAdmin').value || '').trim().toUpperCase();
    
    // Limpiar estado
    listaPagosDiv.innerHTML = '';
    resultadoAdminDiv.textContent = '';
    formularioCorreccionDiv.style.display = 'none';
    idPagoSeleccionado = null;

    if (!idPrestamo) {
        mostrarAdminError('Debe ingresar el ID del Pr√©stamo.');
        return;
    }

    mostrarAdminInfo(`Buscando pagos para Pr√©stamo ${idPrestamo}...`);

    try {
        // Consultar la colecci√≥n 'pagos' donde idPrestamo coincida
        // Ordenar por fecha descendente para ver los m√°s recientes primero
        const q = pagosRef.where('idPrestamo', '==', idPrestamo).orderBy('fecha', 'desc');
        const snapshot = await q.get();

        if (snapshot.empty) {
            listaPagosDiv.innerHTML = '<p class="warn">No se encontraron pagos para este pr√©stamo.</p>';
            mostrarAdminInfo('B√∫squeda completada.');
            return;
        }

        let html = '<h3>Pagos Encontrados (Clic para seleccionar):</h3>';
        
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            const monto = data.monto || 0;
            const fechaDisplay = formatDate(data.fecha);
            const fechaInput = dateToInput(data.fecha);

            html += `
                <div class="pago-item" 
                     onclick="seleccionarPago('${doc.id}', ${monto}, '${fechaInput}')">
                    <strong>ID Pago: ${doc.id}</strong><br>
                    Monto Pagado: $${monto.toFixed(2)} | Fecha: ${fechaDisplay}
                </div>
            `;
        });
        
        listaPagosDiv.innerHTML = html;
        mostrarAdminInfo(`Se encontraron ${snapshot.docs.length} pagos. Seleccione uno para corregir.`);

    } catch (error) {
        console.error("Error al buscar pagos:", error);
        mostrarAdminError(`Error al buscar pagos: ${error.message}`);
    }
}

// === L√ìGICA DE SELECCI√ìN DE PAGO ===
function seleccionarPago(id, monto, fechaInput) {
    idPagoSeleccionado = id;
    
    // Rellenar el formulario de correcci√≥n con los datos actuales
    pagoSeleccionadoIDStrong.textContent = id;
    document.getElementById('montoAdmin').value = monto;
    document.getElementById('fechaAdmin').value = fechaInput;
    
    formularioCorreccionDiv.style.display = 'block';
    mostrarAdminInfo(`Pago ${id} seleccionado. Modifique los campos y presione 'Guardar Correcci√≥n'.`);
}


// === L√ìGICA DE ADMINISTRACI√ìN PARA CORREGIR PAGOS ===
async function corregirPago() {
    const idPago = idPagoSeleccionado; // Usar el ID guardado al seleccionar
    const nuevoMonto = parseFloat(document.getElementById('montoAdmin').value);
    const nuevaFecha = document.getElementById('fechaAdmin').value;

    if (!idPago) {
        mostrarAdminError('Primero debe buscar y seleccionar un pago de la lista.');
        return;
    }

    const updates = {};
    let mensaje = `Pago ${idPago} corregido: `;

    if (!isNaN(nuevoMonto) && nuevoMonto > 0) {
        updates.monto = parseFloat(nuevoMonto.toFixed(2));
        mensaje += `Monto a $${updates.monto.toFixed(2)}. `;
    }

    if (nuevaFecha) {
        try {
            const date = new Date(nuevaFecha);
            if (isNaN(date)) throw new Error('Fecha inv√°lida');
            // Convertir la fecha HTML (YYYY-MM-DD) a Firestore Timestamp
            updates.fecha = firebase.firestore.Timestamp.fromDate(date);
            mensaje += `Fecha a ${nuevaFecha}.`;
        } catch (e) {
            mostrarAdminError('La fecha ingresada no es v√°lida.');
            return;
        }
    }
    
    if (Object.keys(updates).length === 0) {
        mostrarAdminError('No se ingresaron nuevos valores para monto o fecha.');
        return;
    }

    mostrarAdminInfo('Corrigiendo pago...');

    try {
        const pagoDocRef = pagosRef.doc(idPago);
        await pagoDocRef.update(updates);
        
        mostrarAdminInfo(`‚úÖ ${mensaje}`);
        
        // Limpiar el estado de selecci√≥n y el formulario
        idPagoSeleccionado = null;
        pagoSeleccionadoIDStrong.textContent = '--';
        document.getElementById('montoAdmin').value = '';
        document.getElementById('fechaAdmin').value = '';
        formularioCorreccionDiv.style.display = 'none';
        listaPagosDiv.innerHTML = ''; // Limpiar la lista para forzar una nueva b√∫squeda si se necesita.
        document.getElementById('idPrestamoAdmin').value = '';

        // Mensaje de advertencia final
        setTimeout(() => {
            mostrarAdminInfo('¬°√âxito! Recuerde que este cambio *no* actualiz√≥ el saldo del Pr√©stamo.');
        }, 3000);

    } catch (error) {
        console.error("Error al corregir el pago:", error);
        mostrarAdminError(`Error al corregir el pago: ${error.message}. Aseg√∫rese de que el ID del pago sea correcto.`);
    }
}
</script>
</body>
</html>

